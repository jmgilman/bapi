version: "3.9"
services:
  generator:
    build: ../generator
    ports:
      - 8001:8001
    environment:
      - HOST=0.0.0.0
      - PORT=8001
    healthcheck:
      test: curl http://localhost:8001
      interval: 1s
      retries: 10
  redis:
    image: redis
    healthcheck:
      test: redis-cli -h redis --scan | grep -q beancount
      interval: 1s
      retries: 10
  migration:
    build: ./migration
    environment:
      - REDIS_HOST=redis
      - GEN_HOST=generator
      - GEN_PORT=8001
      - PICKLE=${PICKLE}
    depends_on:
      redis:
        condition: service_started
      generator:
        condition: service_healthy
  bapi:
    build: ../..
    ports:
      - 8000:8000
    environment:
      - BAPI_STORAGE=redis
      - BAPI_REDIS__HOST=redis
      - BAPI_REDIS__CACHED=${PICKLE}
      - BAPI_REDIS__SSL=0
    healthcheck:
      test: curl http://localhost:8000/v1/account
      interval: 1s
      retries: 10
    depends_on:
      redis:
        condition: service_healthy
